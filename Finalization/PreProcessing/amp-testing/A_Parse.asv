%reboot;
%load('2022-09-09\analysis\aDBS012_2022-09-09_amplitude-analysis.mat');
a=tgRead('Z:\OCD_Data\preprocessed-new\aDBS012\2022-09-09\amplitude\analysis\audio.TextGrid');
%[wav,Fs]=audioread("audio.wav");
%%
wav = amp_data.audio;
Fs = amp_data.fs_audio;
b=a.tier;
b=a.tier{1};
%%
keep=~cellfun(@isempty,b.Label);
rm=~cellfun(@isempty,strfind(b.Label,'*'));
tOn=b.T1(keep&~rm);
tOff=b.T2(keep&~rm);
t=(tOn+tOff)/2;
w=5;
edges=0:w:max(tOn);
[n,edges]=histcounts(tOn,edges);
n=n/w;
wAmp=zeros(1,length(t));
tW=(1:length(wav))/Fs;
for i=1:length(t)
    wAmp(i)=rms(wav(tW>tOn(i)&tW<tOff(i)));
end
%%
tStim=amp_data.stim_times1;
stimVal=amp_data.stim_changes1(:,1);
stimOn=tStim(stimVal>0);
stimOn=reshape(stimOn,[2,length(stimOn)/2]);
indStim=zeros(size(t));
for i=1:size(stimOn,1)
    indStim=indStim+(t>stimOn(1,i)&t<stimOn(2,i));
end
indStim=logical(indStim);
%%
figure(1);
ax1=subplot(611);
plot(tStim,stimVal);
hold on;
plot(tW,wav*3+2);
xlabel('T (s)')
ylabel('Stim Amplitude (mA)')
title('Association between Stimulation Amplitude and Word Production')
h(2)=subplot(612);
bar(edges((1:end-1))+w/2,n)
title('words per second')
ylabel('Hz')
h(3)=subplot(613);
wordL=tOff-tOn;
yy = smooth(t,wordL,0.05,'rloess');
plot(t,wordL,'.')
hold on;
plot(t,yy,'k')
title('Word Duration')
ylabel('s')
ylim([0,.75])
h(4)=subplot(614);
yy = smooth(t,wAmp,0.05,'rloess');
plot(t,wAmp,'.');
hold on;
plot(t,yy,'k')
xlim(amp_data.stim_times1([1,end]))
%xlabel('T (s)')
h(5)=subplot(615);
[~,f,t,tf]=spectrogram(ch_1,250,125,250,500);
yyaxis right
plot(tStim,stimVal);
ylabel('Stim Amplitude (mA)')

hold on
yyaxis left
%plot(t,cnelab_TF_Smooth(log(abs(tf(f_plot,:))),'gaussian',[1,10]))
b1 = smooth(log(abs(tf(f_plot,:))),20);
plot(t,b1)
ylabel('Beta (29-31 Hz) Power [dB]')

h(6)=subplot(616);
[~,f,t,tf]=spectrogram(ch_2,250,125,250,500);
yyaxis right
plot(tStim,stimVal);
ylabel('Stim Amplitude (mA)')

hold on
yyaxis left
%plot(t,cnelab_TF_Smooth(log(abs(tf(f_plot,:))),'gaussian',[1,10]))
b2 = smooth(log(abs(tf(f_plot,:))),20);
plot(t,b2)
ylabel('Beta (29-31 Hz) Power [dB]')
xlabel('Seconds')
%ax6.XLim = ax1.XLim;
%ax5.XLim =ax1.XLim;
linkaxes(h,'x')


%%
figure(2);clf;
subplot(121);hold on;
w=.05;
edges=0:w:max(wordL);
[n,edges]=histcounts(wordL(indStim),edges);
n=n/sum(n);
[n2,edges]=histcounts(wordL(~indStim),edges);
n2=n2/sum(n2);
bar(edges((1:end-1))+w/2,[n;n2]','hist')
legend('Stimulation On','Stimulation Off')
xlabel('s')
ylabel('n')
title('Word Length')
subplot(122);hold on;

w=.01;
edges=0:w:max(wAmp);
[n,edges]=histcounts(wAmp(indStim),edges);
n=n/sum(n);
[n2,edges]=histcounts(wAmp(~indStim),edges);
n2=n2/sum(n2);
bar(edges((1:end-1))+w/2,[n;n2]','hist')
legend('Stimulation On','Stimulation Off')
xlabel('RMS')
ylabel('n')
title('Word Amplitude')
